
            modalContent.innerHTML = content;
            modal.style.display = 'flex';
        };

        window.editMovement = function (movementId, type) {
            let movement = null;

            // Buscar el movimiento según el tipo
            const searchInCaches = (keys, id) => {
                for (const key of keys) {
                    const data = JSON.parse(localStorage.getItem(key)) || [];
                    const found = data.find(item => (item.id == id || item.invoice_number == id));
                    if (found) return found;
                }
                return null;
            };

            switch (type) {
                case 'sales':
                    movement = searchInCaches(['destelloOroHistorySales', 'destelloOroAllSales', 'destelloOroHistoryPendingSales', 'destelloOroPendingSales'], movementId);
                    break;
                case 'expenses':
                    movement = searchInCaches(['destelloOroHistoryExpenses', 'destelloOroAllExpenses'], movementId);
                    break;
                case 'warranties':
                    movement = searchInCaches(['destelloOroHistoryWarranties', 'destelloOroAllWarranties'], movementId);
                    break;
                case 'product':
                    movement = searchInCaches(['destelloOroProducts'], movementId);
                    break;
                case 'restocks':
                    movement = searchInCaches(['destelloOroHistoryRestocks', 'destelloOroAllRestocks'], movementId);
                    break;
                default:
                    showDialog('Error', 'Tipo de movimiento no válido para edición.', 'error');
                    return;
            }

            if (!movement) {
                showDialog('Error', 'Movimiento no encontrado.', 'error');
                return;
            }

            // Guardar movimiento y tipo para edición
            currentMovementForEdit = movement;
            currentMovementTypeForEdit = type;

            // Configurar modal de edición
            const modal = document.getElementById('editMovementModal');
            const modalTitle = document.getElementById('editMovementTitle');
            const modalContent = document.getElementById('editMovementContent');

            modalTitle.textContent = `Editar ${type === 'sales' ? 'Venta' : type === 'expenses' ? 'Gasto' : type === 'product' ? 'Producto de Inventario' : 'Garantía'}`;

            // Generar formulario según el tipo
            let formContent = '';
            switch (type) {
                case 'sales':
                    // Convertir fecha para el input date
                    let saleDate = '';
                    try {
                        saleDate = new Date(movement.date).toISOString().split('T')[0];
                    } catch(e) {
                         saleDate = movement.date ? movement.date.split(' ')[0] : '';
                    }

                    formContent = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-calendar"></i> Fecha de Venta
                                </label>
                                <input type="date" name="date" value="${saleDate}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-hashtag"></i> Número de Factura
                                </label>
                                <input type="text" name="invoiceNumber" value="${movement.id}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-user"></i> Nombre del Cliente
                            </label>
                            <input type="text" name="customerName" value="${movement.customerInfo?.name || movement.customer_name || ''}" 
                                   class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-id-card"></i> Cédula
                                </label>
                                <input type="text" name="customerId" value="${movement.customerInfo?.id || movement.customer_id || ''}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-phone"></i> Teléfono
                                </label>
                                <input type="text" name="customerPhone" value="${movement.customerInfo?.phone || movement.customer_phone || ''}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-money-bill"></i> Subtotal
                                </label>
                                <input type="number" name="subtotal" value="${movement.subtotal || 0}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" step="0.01">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-truck"></i> Envío
                                </label>
                                <input type="number" name="deliveryCost" value="${movement.deliveryCost || 0}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" step="0.01">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-tag"></i> Descuento
                                </label>
                                <input type="number" name="discount" value="${movement.discount || 0}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" step="0.01">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-shield-alt"></i> Inc. Garantía
                                </label>
                                <input type="number" name="warrantyIncrement" value="${movement.warrantyIncrement || 0}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                                       min="0" step="0.01">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-credit-card"></i> Pago
                                </label>
                                <select name="paymentMethod" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    ${Object.entries(paymentMethods).map(([key, method]) => `
                                        <option value="${key}" ${movement.paymentMethod === key ? 'selected' : ''}>${method.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-check-circle"></i> Estado
                            </label>
                            <select name="status" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="pending" ${!movement.confirmed && movement.status !== 'completed' ? 'selected' : ''}>Pendiente</option>
                                <option value="completed" ${movement.confirmed || movement.status === 'completed' ? 'selected' : ''}>Completada</option>
                            </select>
                        </div>
                    `;
                    break;

                case 'expenses':
                    // Convertir fecha para el input date
                    let expenseDateEdit = '';
                    try {
                        expenseDateEdit = movement.date ? movement.date.split(' ')[0] : '';
                    } catch(e) {
                         expenseDateEdit = '';
                    }

                    formContent = `
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-receipt"></i> Descripción
                            </label>
                            <input type="text" name="description" value="${movement.description}" 
                                   class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-calendar"></i> Fecha
                            </label>
                            <input type="date" name="date" value="${expenseDateEdit}"  
                                   class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-money-bill"></i> Valor
                            </label>
                            <input type="number" name="amount" value="${movement.amount}" 
                                   class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                                   min="0" step="0.01" required>
                        </div>
                    `;
                    break;

                case 'warranties':
                    // Convertir fecha de garantía
                    let warrantyDate = '';
                    try {
                        warrantyDate = new Date(movement.createdAt).toISOString().split('T')[0];
                    } catch(e) {
                         warrantyDate = movement.createdAt ? movement.createdAt.split(' ')[0] : '';
                    }

                    formContent = `
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-calendar"></i> Fecha
                            </label>
                            <input type="date" name="date" value="${warrantyDate}" 
                                   class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-exclamation-triangle"></i> Motivo de Garantía
                            </label>
                            <select name="warrantyReason" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                ${Object.entries(warrantyReasons).map(([key, reason]) => `
                                    <option value="${key}" ${movement.warrantyReason === key ? 'selected' : ''}>${reason}</option>
                                `).join('')}
                            </select>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-layer-group"></i> Cantidad
                            </label>
                            <input type="number" name="quantity" value="${movement.quantity || 1}" 
                                   class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" min="1" required>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-exchange-alt"></i> Tipo de Producto
                            </label>
                            <select id="editWarrantyProductType" name="productType" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                <option value="same" ${movement.productType === 'same' ? 'selected' : ''}>Mismo producto</option>
                                <option value="different" ${movement.productType === 'different' ? 'selected' : ''}>Producto diferente</option>
                            </select>
                        </div>
                        
                        <div id="editWarrantyDifferentFields" style="display: ${movement.productType === 'different' ? 'block' : 'none'};">
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-barcode"></i> Ref. Nuevo Producto
                                    </label>
                                    <input type="text" name="newProductRef" value="${movement.newProductRef || ''}" 
                                           class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <div class="edit-product-status" style="font-size: 0.8rem; margin-top: 4px; font-weight: 500;"></div>
                                </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-tag"></i> Nombre Nuevo Producto
                                </label>
                                <input type="text" name="newProductName" value="${movement.newProductName || ''}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-plus-circle"></i> Valor Adicional
                                </label>
                                <input type="number" name="additionalValue" value="${movement.additionalValue || 0}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                                       min="0" step="0.01">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <i class="fas fa-truck"></i> Valor Envío
                                </label>
                                <input type="number" name="shippingValue" value="${movement.shippingValue || 0}" 
                                       class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                                       min="0" step="0.01">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <i class="fas fa-check-circle"></i> Estado
                            </label>
                            <select name="status" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                                <option value="pending" ${movement.status === 'pending' ? 'selected' : ''}>Pendiente</option>
                                <option value="in_process" ${movement.status === 'in_process' ? 'selected' : ''}>En proceso</option>
                                <option value="completed" ${movement.status === 'completed' ? 'selected' : ''}>Completada</option>
                                <option value="cancelled" ${movement.status === 'cancelled' ? 'selected' : ''}>Cancelada</option>
                            </select>
                        </div>
